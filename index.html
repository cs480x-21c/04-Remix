<!DOCTYPE html>
<html>

<head>
  <!-- favicon error -->
  <link rel="shortcut icon" href="#">
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 0px;
    }

    .bar {
      fill: orange;
    }

    .bar:hover {
      fill: orangered;
    }
  </style>
</head>

<body>


  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <!-- <script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="https://d3js.org/d3-geo.v2.min.js"></script> -->
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reductio/1.0.0/reductio.min.js" integrity="sha512-dpNFXYxfvCC775pj8TELHq4usthTiHrwSx4IcgZBnsHvBTIU1pm8jWXQaNhzY+AxjrlxgLXVtxktAWOo/0oCKA==" crossorigin="anonymous"></script>
  <script src="js/barChart.js"></script>

  <svg width=960 height=600>
  </svg>

  <div id="info">
  </div>
  <div class="grid-container">
    <div class="grid-child">
      <h2>Earnings by Year (GEL)</h2>
      <div class="barChart" id="earningsByYear"></div>
    </div>
    <div class="grid-child">
      <h2>Earnings by Region (GEL)</h2>
      <div class="barChart" id="earningsByRegion"></div>
    </div>
  </div>
  <script>
    Promise.all(
      [
        d3.json('georgia.geojson'),
        d3.csv("earningsRegions.csv")
      ]
    ).then(([countries, earnings]) => {
      createMap(countries, earnings)
    });


    var barChartYear = barChart()
      .x(function(d) {
        return d.key;
      })
      .y(function(d) {
        return d.value;
      });

    var barChartRegion = barChart()
      .x(function(d) {
        return d.key;
      })
      .y(function(d) {
        return d.value;
      });


    function createMap(regions, earnings) {

      //console.map(regions);
      var width = 600;
      var height = 600;

      var proj = d3.geoEqualEarth();

      proj.fitSize([height, width], regions);

      var gpath = d3.geoPath()
        .projection(proj);


      var color =
        d3.scaleSequential(d3.interpolateBlues)
        .domain(d3.extent(regions.features, d => gpath.area(d)));



      var svg = d3.select('svg')
        .selectAll('path')
        .data(regions.features)
        .enter()
        .append('path')
        .attr('d', function(d) {
          return gpath(d);
        })
        .attr('stroke-width', 1)
        .attr('stroke', 'black')
        //  .attr('label', d=> console.log(d.properties['NAME_1']))
        //  .attr('country', d=> console.log(d.properties['NAME_1']))
        .attr('fill', d => color(gpath.area(d)))
        .on("mouseover", function(e, d) {
          console.log(d.properties['NAME_1']);
        })
        .on("mouseout", function(d, i) {});



      var data = crossfilter(earnings);




      data.year = data.dimension(function(d) {
        return d.Year;
      });

      data.region = data.dimension(function(d) {
        return d.Region;
      });

      //logGroup(byYear.top(Infinity));
      // TODO only include Totals
      data.yearGroup = data.year.group().reduceSum(function(d) {
        return d.AvgEarning;
      });
      data.regionGroup = data.region.group().reduceSum(function(d) {
        return d.AvgEarning;
      });

      //      logGroup(yearGroup.top(Infinity));

      barChartRegion.onMouseOver(function(e, d) {
        //console.log(d.key);
        data.region.filterExact(d.key);
        update();
      }).onMouseOut(function() {
        data.region.filterAll();
        update();
      });

      barChartYear.onMouseOver(function(e, d) {
        //  console.log(d.key);
        data.year.filterExact(d.key);
        update();
      }).onMouseOut(function() {
        data.year.filterAll();
        update();
      });



      function update() {
        d3.select("#earningsByYear")
          .datum(data.yearGroup.all())
          .call(barChartYear);
        d3.select("#earningsByRegion")
          .datum(data.regionGroup.all())
          .call(barChartRegion);
      }

      update();

      function logGroup(data) {
        data.forEach(function(x) {
          console.log(JSON.stringify(x));
        });
      }
    }
  </script>
</body>


</html>
