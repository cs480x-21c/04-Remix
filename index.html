<!DOCTYPE html>

<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

<html>

    <body>

        <div id="visContainer">
            <svg id="lineSvg"></svg><br><br>
            <svg id="barSvg"></svg>
        </div>

    </body>

    <script>
        console.log(d3);

        let margin = {
            left: 60,
            top: 10,
            right: 10,
            bottom: 10
        };

        let height = 480 - margin.top - margin.bottom;
        let width = 640 - margin.left - margin.right;

        let minPopulation = 780000

        let svg = d3.select('#lineSvg');

        svg.style('width', width + margin.left + margin.right)
        .style('height', height + margin.top + margin.bottom);

        let app = new Vue({
            el: '#visContainer',
            data: {
                totalData: null,
                maleData: null,
                femaleData: null
            },
            mounted: async function() {
                await this.createLineChart();
            },
            methods: {
                async createLineChart() {

                    let data = await d3.csv('gonorrhea_data.csv');

                    svg = d3.select('#lineSvg');

                    let group = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                    //convert strings to ints
                    for(let d of data) {
                        d.Rate = parseInt(d.Rate);
                        d.Population = parseInt(d.Population);
                    }

                    //remove missing values
                    data = data.filter(d => !isNaN(d.Rate));

                    //filter based on population
                    data = data.filter(d => d.Population >= minPopulation);
                    
                    console.log(data);

                    let totalData = data.filter(d => d.Sex == 'Total');
                    let maleData = data.filter(d => d.Sex == 'Male');
                    let femaleData = data.filter(d => d.Sex == 'Female');

                    console.log(totalData);

                    let xScale = d3.scaleTime()
                    .domain([d3.timeParse('%Y')(2001), d3.timeParse('%Y')(2018)])
                    .range([0, width-margin.right]);

                    let yScale = d3.scaleLinear()
                    .domain([0, d3.max(totalData, (d) => { return d.Rate })])
                    .range([height, 0]);



                    //create x axis
                    svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${height})`)
                    .call(d3.axisBottom(xScale));

                    //create y axis
                    svg.append('g')
                    .attr('transform', `translate(${margin.left}, 0)`)
                    .call(d3.axisLeft(yScale));

                    let totalGroupings = d3.group(totalData, d => d.County);
                    let maleGroupings = d3.group(maleData, d => d.County);
                    let femaleGroupings = d3.group(femaleData, d => d.County);

                    let counties = totalGroupings.keys();
                    let color = d3.scaleOrdinal()
                    .domain(counties)
                    .range(["#58b5e1", "#7a3003", "#59d13e", "#a52e78", "#a9c358", "#a261f6", "#57832e", "#ef3df3", "#fcce6a", "#4f28af", "#fd8f20", "#2a538a", "#4aeeb6"]);

                    let line = d3.line()
                    .x((d) => { return xScale(d3.timeParse('%Y')(d.Year)); })
                    .y((d) => { return yScale(d.Rate); })

                    console.log(totalGroupings)

                    group.selectAll('line')
                    .data(totalGroupings)
                    .enter()
                    .append('path')
                        .attr('class', 'lcLine')
                        .attr('fill', 'none')
                        .attr('stroke', (d) => { return color(d[0]) })
                        .attr('stroke-width', 1)
                        .attr('d', function(d) {
                            return line(d[1]);
                        })
                        .on('mouseover', function (event, d) {
                            d3.select(event.target).attr('stroke-width', 3);
                        })
                        .on('mouseout', function (event, d) {
                            d3.select(event.target).attr('stroke-width', 1);
                        })

                },

                createBarChart() {
                    console.log('bar chart');
                }

            }


        })

    </script>

    <style>
        .lcLine {
            cursor: pointer;
        }
    </style>

</html>