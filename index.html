<!DOCTYPE html>
<meta charset='utf-8'>

<script src="http://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<style>
    .slider {
        -webkit-appearance: none;
        width: 400px;
        height: 15px;
        border-radius: 5px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
    }

    .slider:hover {
        opacity: 1;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: steelblue;
        cursor: pointer;
    }

    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #4CAF50;
        cursor: pointer;
    }
    .myCircle:hover {
        stroke: black;
    }
</style>

<div id="div1">
    <h1 id="mapHeader"> </h1>
</div>
<p>
    <label> 1990 </label>
    <input type="range" id="yearSlider" class="slider" min="1990" max="2018" step="1" value="2018">
    <label> 2018 </label>
</p>
<div id="div2">
    <h1 id="lineHeader"> </h1>
</div>

<script>
    // Initialization for Map svg
    let svgMap = d3.select('#div1')
        .append('svg')
        .attr('width', 500)
        .attr('height', 350)
        // .call(d3.zoom().on('zoom', function () {
        //     svgMap.attr('transform', d3.event.transform)
        // }))

    widthMap = svgMap.attr('width')
    heightMap = svgMap.attr('height')

    // Initialization for Line Chart svg
    let marginLine = {top: 10, right: 30, bottom: 30, left: 60},
        widthLine = 500 - marginLine.left - marginLine.right,
        heightLine = 300 - marginLine.top - marginLine.bottom

    let svgLine = d3.select('#div2')
        .append('svg')
        .attr('width', widthLine + marginLine.left + marginLine.right)
        .attr('height', heightLine + marginLine.top + marginLine.bottom)
        .append('g')
        .attr('transform', 'translate(' + marginLine.left + ',' + marginLine.top + ')')

    // Ready data storage
    let yearlyData = {
        '2018': d3.map(),
        '2017': d3.map(),
        '2016': d3.map(),
        '2015': d3.map(),
        '2014': d3.map(),
        '2013': d3.map(),
        '2012': d3.map(),
        '2011': d3.map(),
        '2010': d3.map(),
        '2009': d3.map(),
        '2008': d3.map(),
        '2007': d3.map(),
        '2006': d3.map(),
        '2005': d3.map(),
        '2004': d3.map(),
        '2003': d3.map(),
        '2002': d3.map(),
        '2001': d3.map(),
        '2000': d3.map(),
        '1999': d3.map(),
        '1998': d3.map(),
        '1997': d3.map(),
        '1996': d3.map(),
        '1995': d3.map(),
        '1994': d3.map(),
        '1993': d3.map(),
        '1992': d3.map(),
        '1991': d3.map(),
        '1990': d3.map()
    }
    let stateData = {
        'Alabama': d3.map(),
        'Alaska': d3.map(),
        'Arizona': d3.map(),
        'Arkansas': d3.map(),
        'California': d3.map(),
        'Colorado': d3.map(),
        'Connecticut': d3.map(),
        'Delaware': d3.map(),
        'District of Columbia': d3.map(),
        'Florida': d3.map(),
        'Georgia': d3.map(),
        'Hawaii': d3.map(),
        'Idaho': d3.map(),
        'Illinois': d3.map(),
        'Indiana': d3.map(),
        'Iowa': d3.map(),
        'Kansas': d3.map(),
        'Kentucky': d3.map(),
        'Louisiana': d3.map(),
        'Maine': d3.map(),
        'Maryland': d3.map(),
        'Massachusetts': d3.map(),
        'Michigan': d3.map(),
        'Minnesota': d3.map(),
        'Mississippi': d3.map(),
        'Missouri': d3.map(),
        'Montana': d3.map(),
        'Nebraska': d3.map(),
        'Nevada': d3.map(),
        'New Hampshire': d3.map(),
        'New Jersey': d3.map(),
        'New Mexico': d3.map(),
        'New York': d3.map(),
        'North Carolina': d3.map(),
        'North Dakota': d3.map(),
        'Ohio': d3.map(),
        'Oklahoma': d3.map(),
        'Oregon': d3.map(),
        'Pennsylvania': d3.map(),
        'Puerto Rico': d3.map(),
        'Rhode Island': d3.map(),
        'South Carolina': d3.map(),
        'South Dakota': d3.map(),
        'Tennessee': d3.map(),
        'Texas': d3.map(),
        'Utah': d3.map(),
        'Vermont': d3.map(),
        'Virginia': d3.map(),
        'Virgin Islands':d3.map(),
        'Washington': d3.map(),
        'West Virginia': d3.map(),
        'Wisconsin': d3.map(),
        'Wyoming': d3.map()
    }
    //TODO: Put national back in the data set?
    let currState = 'Alabama'

    // Ready everything for drawing a map
    let colorScale = d3.scaleThreshold()
        .domain([.06, .12, .18, .24, .3, .36, .42, .48, .54])
        .range(d3.schemeBlues[9])
    let path = d3.geoPath()
    let projection = d3.geoAlbersUsa().scale(700).translate([widthMap / 2, heightMap / 2])

    // Queue up the Line chart data
    d3.queue()
        .defer(d3.csv, 'data.csv', function (d) {
            stateData[d.Location].set(d.TimeFrame, d.Data)
        })
        .await(readyLineChart)

    // Queue up the Map data
    d3.queue()
        .defer(d3.json, 'gz_2010_us_040_00_5m.json')
        .defer(d3.csv, 'data.csv', function (d) {
            yearlyData[d.TimeFrame].set(d.Location, d.Data)
        })
        .await(readyMap)

    let tooltip = d3.select('#div2')
        .append('div')
        .style("opacity", 0)
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "2px")
        .style("border-radius", "5px")
        .style("padding", "5px")
    function readyLineChart() {
        document.getElementById('lineHeader').innerText = 'Non-marital Births in ' + currState

        // Debugging stuff
        console.log('Current State: ' + currState)

        // Clear space fro drawing new chart
        svgLine.selectAll('*').remove()

        let data = stateData[currState]
        let x = d3.scaleLinear()
            .domain(d3.extent(data.keys(), function (d) {
                return d
            }))
            .range([0, widthLine])
        svgLine.append('g')
            .attr('transform', 'translate(0,' + heightLine + ')')
            .call(d3.axisBottom(x).tickFormat(d3.format('d')))

        let y = d3.scaleLinear()
            .domain([d3.min(data.keys(), function (d) {
                return data.get(d)
            }), d3.max(data.keys(), function (d) {
                return data.get(d)
            })])
            .range([heightLine, 0])
        svgLine.append('g')
            .call(d3.axisLeft(y))

        svgLine.append('path')
            .datum(data.entries())
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 2)
            .attr("d", d3.line()
                .x(function (d) {
                    return x(d.key)
                })
                .y(function (d) {
                    return y(d.value)
                })
            )


        let mouseover = function (d) {
            tooltip.style('opacity', 1)
        }
        let mousemove = function (d) {
            tooltip
                .html((d.value * 100).toPrecision((3)) + '% of births in ' + d.key)
                .style("left", (d3.mouse(this)[0] + 70)+ "px")
                .style("top", (d3.mouse(this)[1]) + "px")
        }
        let mouseleave = function (d) {
            tooltip.style('opacity', 0)
        }

        svgLine
            .append('g')
            .selectAll('dot')
            .data(data.entries())
            .enter()
            .append('circle')
            .attr('class', 'myCircle')
            .attr("cx", function (d) {
                return x(d.key)
            })
            .attr("cy", function (d) {
                return y(d.value)
            })
            .attr("r", 5)
            .attr("fill", "steelblue")
            .on('mouseover', mouseover)
            .on('mousemove', mousemove)
            .on('mouseleave', mouseleave)
    }

    function readyMap(error, topo) {
        svgMap.selectAll('*').remove()
        let mouseOver = function (d) {
            currState = d.properties.NAME
            readyLineChart()
            toolTip.style('opacity', 1)
            d3.selectAll('.State')
                .transition()
                .duration(200)
                .style('opacity', .7)
                .style('stroke', 'transparent')
            d3.select(this)
                .transition()
                .duration(200)
                .style('opacity', 1)
                .style('stroke', 'black')
        }

        let mouseLeave = function (d) {
            toolTip.style('opacity', 0)
            d3.selectAll('.State')
                .transition()
                .duration(200)
                .style('opacity', 1)
            d3.select(this)
                .transition()
                .duration(200)
                .style('stroke', 'transparent')
        }

        let toolTip = d3.select('#div1')
            .append('div')
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")

        let mouseMove = function (d) {
            toolTip
                .html((d.total * 100).toPrecision(3) + '% of births in ' + d.properties.NAME)
                .style("left", (d3.mouse(this)[0]) + "px")
                .style("top", (d3.mouse(this)[1]) + "px")
        }

        function updateMap(currYear) {
            document.getElementById('mapHeader').innerText = 'Non-marital Births in the US in ' + currYear

            //TODO: make the slider better and current year labeled
            console.log('Current year is: ' + currYear)
            svgMap.append('g')
                .selectAll('path')
                .data(topo.features)
                .enter()
                .append('path')
                .attr('d', d3.geoPath()
                    .projection(projection))
                .attr('fill', function (d) {
                    d.total = yearlyData[currYear].get(d.properties.NAME) || 0;
                    return colorScale(d.total)
                })
                .style('stroke', 'transparent')
                .attr('class', function (d) {
                    return 'State'
                })
                .style('opacity', 0.8)
                .on('mouseover', mouseOver)
                .on('mouseleave', mouseLeave)
                .on('mousemove', mouseMove)
        }
        updateMap('2018')
        d3.select('#yearSlider').on('change', function () {
            updateMap(this.value)
        })
    }


</script>