<!DOCTYPE html>
<html>

<head>
  <!-- favicon error -->
  <link rel="shortcut icon" href="#">
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 6px;
    }

    .row {
      display: flex;
    }

    /* .block {
      width: 100px;
      display: table-cell;
    } */

    .bar {
      fill: orange;
    }

    .bar:hover {
      fill: orangered;
    }


    .tooltip-map {
      position: absolute;
      text-align: left;
      padding: .5rem;
      background: #FFFFFF;
      color: #313639;
      border: 1px solid #313639;
      border-radius: 8px;
      pointer-events: none;
      font-size: 1em;
    }
  </style>
</head>

<body>


  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <!-- <script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="https://d3js.org/d3-geo.v2.min.js"></script> -->
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reductio/1.0.0/reductio.min.js" integrity="sha512-dpNFXYxfvCC775pj8TELHq4usthTiHrwSx4IcgZBnsHvBTIU1pm8jWXQaNhzY+AxjrlxgLXVtxktAWOo/0oCKA==" crossorigin="anonymous"></script>
  <script src="js/barChart.js"></script>



  <div class="row">
    <div class="block">
      <h2>Average Monthly Earnings by Region(GEL)</h2>
      <svg width=800 height=600>
      </svg>
    </div>
    <div class="block">
      <h2>Average Monthly Earnings by Year (GEL)</h2>
      <div class="barChart" id="earningsByYear"></div>
    </div>
  </div>

  <script>
    Promise.all(
      [
        d3.json('georgia.geojson'),
        d3.csv("earningsRegions.csv")
      ]
    ).then(([countries, earnings]) => {
      createMap(countries, earnings)
    });


    var barChartYear = barChart()
      .x(function(d) {
        return d.key;
      })
      .y(function(d) {
        return d.value;
      });

    var barChartRegion = barChart()
      .x(function(d) {
        return d.key;
      })
      .y(function(d) {
        return d.value;
      });


    function createMap(regions, earnings) {


      var width = 600;
      var height = 600;

      var currentMin = 0;
      var currentMax = 1000;

      var currentValue = -1;

      //Crossfilter values for data
      var data = crossfilter(earnings);

      data.year = data.dimension(function(d) {
        return d.Year;
      });
      data.region = data.dimension(function(d) {
        return d.Region;
      });

      data.region.filterExact("Total");

      data.yearGroup = data.year.group().reduceSum(function(d) {
        return d.AvgEarning;
      });

      data.regionGroup = data.region.group().reduceSum(function(d) {
        return d.AvgEarning;
      });

      reductio().avg('AvgEarning')(data.regionGroup);

      //Hover over bar chart to choose year
      barChartYear.onMouseOver(function(e, d) {
        currentMin = data.year.top(1)[0].AvgEarning;
        currentMax = data.year.bottom(1)[0].AvgEarning;
        data.year.filterExact(d.key);
        update();
      }).onMouseOut(function() {
        data.year.filterAll();
        update();
      });

      update();

      //Update/Create the bar chart
      function update() {

        d3.select("#earningsByYear")
          .datum(data.yearGroup.all())
          .call(barChartYear);

      }

      //console.log crossfilter data
      function logGroup(data) {
        data.forEach(function(x) {
          console.log(JSON.stringify(x));
        });
      }



      //CREATE MAP

      var proj = d3.geoEqualEarth();

      proj.fitSize([height, width], regions);

      var gpath = d3.geoPath()
        .projection(proj);

      //define color
      var color =
        d3.scaleSequential(d3.interpolateRdBu)
        .domain(d3.extent([currentMin, currentMax])) //[currentMin, currentMax]))


      var svg = d3.select('svg')
        .selectAll('path')
        .data(regions.features)
        .enter()
        .append('path')
        .attr('d', function(d) {
          return gpath(d);
        })
        .attr('stroke-width', 1)
        .attr('stroke', 'black')
        .attr('fill', function(d) {

          //No data on Abkhazia due to political reasons
          if (d.properties['NAME_1'] === "Abkhazia") {
            return "white";
          }

          data.region.filterExact(d.properties['NAME_1']);

          var gr = data.regionGroup.top(Infinity);
          var i;
          for (i = 0; i < gr.length; i++) {
          if(gr[i].key === d.properties['NAME_1']){
            return color(gr[i].value.avg);
          }
          }
          data.region.filterAll();
          data.region.filterExact("Total");
          return "black";//color(gpath.area(d));
          //pass AvgEarning of each region to color

        });

      var tip = d3.select("body").append("div")
        .attr("class", "tooltip-map")
        .style("opacity", 0);

      svg.on("mouseover", function(e, d) {
          // Filter the data to only include the Region Hovered On
          data.region.filterExact(d.properties['NAME_1']);
          //Update the current data min and Max
          var message = d.properties['NAME_1'];
          if (d.properties['NAME_1'] !== "Abkhazia") {
            currentMin = data.year.top(1)[0].AvgEarning;
            currentMax = data.year.bottom(1)[0].AvgEarning;
            update();
          }
          //       console.log(d3.extent([currentMin, currentMax]));
          // console.log("Min "+currentMin + "  "+color(currentMin));
          //     console.log("Max "+currentMax + "  "+color(currentMax));
          // console.log("MIN map "+currentMin);
          // console.log("MAX map"+ currentMax);
          //logGroup(data.yearGroup.top(Infinity));


          d3.select(this).transition()
            .duration('50')
            .attr('opacity', '0.5');

          tip.transition()
            .duration(50)
            .style("opacity", 1);



          tip.html(message)
            .style("left", (e.pageX + 10) + "px")
            .style("top", (e.pageY - 15) + "px");
        })
        .on("mouseout", function(e, d) {
          data.region.filterAll();
          data.region.filterExact("Total");
          update();

          d3.select(this).transition()
            .duration('50')
            .attr('opacity', '1');
          tip.transition()
            .duration('50')
            .style("opacity", 0);
        });


      // var mapZoom = d3.zoom()
      //   .on('zoom', zoomed);
      //
      // var zoomSettings = d3.zoomIdentity
      //   .translate(250, 250)
      //   .scale(120);
      //
      // d3.select('svg')
      //   .call(mapZoom)
      //   .call(mapZoom.transform, zoomSettings);
      //
      //
      // function zoomed(e) {
      //   proj.translate([e.transform.x, e.transform.y])
      //   .scale(e.transform.k);
      //
      //   //redrowing map
      //   d3.selectAll('path')
      //   .attr('d', gpath);
      //
      // }
    }
  </script>
</body>


</html>
