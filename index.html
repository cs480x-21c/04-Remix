<!DOCTYPE html>
<html>

<head>
  <!-- favicon error -->
  <link rel="shortcut icon" href="#">
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 6px;
    }

    .row {
      display: flex;
    }

    /* .bar {
      fill: #25659e;
    } */

    .bar:hover {
      fill: #afd3e6;
    }

    .tooltip-map {
      position: absolute;
      text-align: left;
      padding: .5rem;
      background: #FFFFFF;
      color: #313639;
      border: 1px solid #313639;
      border-radius: 8px;
      pointer-events: none;
      font-size: 1em;
    }
    h2{
      height:50px;
      text-align: center;
    }
  </style>
</head>

<body>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reductio/1.0.0/reductio.min.js" integrity="sha512-dpNFXYxfvCC775pj8TELHq4usthTiHrwSx4IcgZBnsHvBTIU1pm8jWXQaNhzY+AxjrlxgLXVtxktAWOo/0oCKA==" crossorigin="anonymous"></script>
  <script src="js/barChart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ==" crossorigin="anonymous"></script>

  <div class="row">

    <div id="mapBlock">
      <h2 id='mapHeader'>Average Monthly Earnings by Region(GEL)</h2>
      <div class="row" >
        <svg id="mapLegendSVG" style="margin-top: 50px; margin-left:15px">
        </svg>
        <svg id="map" style="border: 0.1em solid black; margin-top: 20px">
        </svg>
      </div>

    </div>
    <div class="block">
      <h2 id='barHeader'>Average Monthly Earnings by Year(GEL)</h2>
      <div class="barChart" id="earningsByYear" style="margin-left:30px"></div>
    </div>
  </div>

  <script>
    Promise.all(
      [
        d3.json('data/georgia.geojson'),
        d3.csv('data/earningsRegions.csv')
      ]
    ).then(([countries, earnings]) => {
      createMap(countries, earnings)
    });

    var barChartYear = barChart()
      .x(function(d) {
        return d.key;
      })
      .y(function(d) {
        return d.value;
      });

    function createMap(regions, earnings) {
    //  console.log(innerWidth);
    //  console.log(innerHeight);
      //map width and height
      var widthMap = 700;
      var heightMap = 430;

      var widthLegend = 150;
      var heightLegend = 350;

      var clickedMap = false;
      //var clickedGraph =false;
      //data
      var currentMin = 0;
      var currentMax = 1300;
      var defaultMin = 0;
      var defaultMax = 1350;
      var currentValue = -1;

      var barColor = '#25659e';
      var defaultBarColor ='#25659e';
      //Crossfilter values for data
      var data = crossfilter(earnings);
      data.year = data.dimension(function(d) {
        return d.Year;
      });
      data.region = data.dimension(function(d) {
        return d.Region;
      });
      data.region.filterExact("Total");
      data.yearGroup = data.year.group().reduceSum(function(d) {
        return d.AvgEarning;
      });
      data.regionGroup = data.region.group().reduceSum(function(d) {
        return d.AvgEarning;
      });
      reductio().avg('AvgEarning')(data.regionGroup);


      //Hover over bar chart to choose year
      barChartYear.onMouseOver(function(e, d) {
        if(!clickedMap){
        data.year.filterExact(d.key);
        currentMin = 0; //data.year.top(1)[0].AvgEarning;
        currentMax = data.year.bottom(1)[0].AvgEarning;
        update();
        //change color on the map
        changeColorMap();
        document.getElementById("mapHeader").innerHTML = d.key +" Average Monthly Earnings by Region(GEL)";
      }
      }).onMouseOut(function() {
        if(!clickedMap){
        currentMin = defaultMin;
        currentMax = defaultMax;
        data.year.filterAll();
        update();
        changeColorMap();
        document.getElementById("mapHeader").innerHTML ="Average Monthly Earnings by Region(GEL)";
      }
      });

      update();

      //Update/Create the bar chart
      function update() {
        d3.select("#earningsByYear")
          .datum(data.yearGroup.all())
          .call(barChartYear);
        d3.select("#earningsByYear").selectAll('.bar')
            .attr('fill', barColor);
      }

      //CREATE MAP
      var proj = d3.geoEqualEarth();
      proj.fitSize([heightMap , widthMap], regions);

      var gpath = d3.geoPath()
        .projection(proj);

      //define color
      var color =
        d3.scaleSequential(d3.interpolateRdBu)
        .domain(d3.extent([currentMin, currentMax])) //[currentMin, currentMax]))

      //setting size
      d3.select('#map').attr('width', widthMap)
                .attr('height', heightMap);
      var svg = d3.select('#map')
        .selectAll('path')
        .data(regions.features)
        .enter()
        .append('path')
        .attr('d', function(d) {
          return gpath(d);
        })
        .attr('stroke-width', 1)
        .attr('stroke', 'black')
        .attr('fill', function(d) {
          //No data on Abkhazia due to political reasons
          if (d.properties['NAME_1'] === "Abkhazia") {
            return "white";
          }
          data.region.filterExact(d.properties['NAME_1']);

          var gr = data.regionGroup.top(Infinity);
          var i;
          for (i = 0; i < gr.length; i++) {
            if (gr[i].key === d.properties['NAME_1']) {
              return color(gr[i].value.avg);
            }
          }
          data.region.filterAll();
          data.region.filterExact("Total");
          return "black"; //color(gpath.area(d));
        });


      // add a legend
      //https://bl.ocks.org/wboykinm/dbbe50d1023f90d4e241712395c27fb3

      var key = d3.select("#mapLegendSVG")
        .attr("width", widthLegend)
        .attr("height", heightLegend)
        .attr("class", "legend");

      var legend = key.append("defs")
        .append("svg:linearGradient")
        .attr("id", "gradient")
        .attr("x1", "100%")
        .attr("y1", "0%")
        .attr("x2", "100%")
        .attr("y2", "100%")
        .attr("spreadMethod", "pad");

      legend.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#25659e")
        .attr("stop-opacity", 1);

      legend.append("stop")
        .attr("offset", "50%")
        .attr("stop-color", "#f2efee")
        .attr("stop-opacity", 1);


      legend.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#c94842")
        .attr("stop-opacity", 1);

      key.append("rect")
        .attr("width", widthLegend-70)
        .attr("height", heightLegend)
        .style("fill", "url(#gradient)")
        .attr("transform", "translate(0,10)");
      var y = d3.scaleLinear()
        .range([heightLegend, 0])
        .domain([defaultMin, defaultMax]);
      var yAxis = d3.axisRight(y);
      key.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(80,10)")
        .call(yAxis)

      //change color of the map
      function changeColorMap() {
        svg.attr('fill', function(d) {
          // console.log(d.properties['NAME_1']);
          //No data on Abkhazia due to political reasons
          if (d.properties['NAME_1'] === "Abkhazia") {
            return "white";
          }
          data.region.filterExact(d.properties['NAME_1']);
          var gr = data.regionGroup.top(Infinity);
          var i;
          for (i = 0; i < gr.length; i++) {
            if (gr[i].key === d.properties['NAME_1']) {
              return color(gr[i].value.avg);
            }
          }
          data.region.filterAll();
          data.region.filterExact("Total");
          return "black"; //color(gpath.area(d));
        });
      }

      //map hover over and show names
      var tip = d3.select("body").append("div")
        .attr("class", "tooltip-map")
        .style("opacity", 0);

      svg.on("mouseover", function(e, d) {
        if(!clickedMap){
        // Filter the data to only include the Region Hovered On
        data.region.filterExact(d.properties['NAME_1']);
        //Update the current data min and Max
        var message = d.properties['NAME_1'];
        if (d.properties['NAME_1'] !== "Abkhazia") {
          currentMin = data.year.bottom(1)[0].AvgEarning;
          currentMax = data.year.top(1)[0].AvgEarning;
          document.getElementById("barHeader").innerHTML = d.properties['NAME_1'] + " Average Monthly Earnings by Year(GEL)";
          mapMouseOn(e,d);
          update();
        } else {
          message = message + "<br> No Data Available";
        }
        d3.select(this).transition()
          .duration('50')
          .attr('opacity', '0.5');

        tip.transition()
          .duration(50)
          .style("opacity", 1);

        tip.html(message)
          .style("left", (e.pageX + 10) + "px")
          .style("top", (e.pageY - 15) + "px");
        //Change bar header

        }
        })
        .on("mouseout", function(e, d) {
          if(!clickedMap){
          currentMin = defaultMin;
          currentMax = defaultMax;
          data.region.filterAll();
          data.region.filterExact("Total");
          barColor = defaultBarColor;
          update();

          d3.select(this).transition()
            .duration('50')
            .attr('opacity', '1');
          tip.transition()
            .duration('50')
            .style("opacity", 0);

          document.getElementById("barHeader").innerHTML = "Average Monthly Earnings by Year(GEL)";
          }
        //Change bar header
          //mapMouseOut(e,d);
        });


    svg.on("click", function (e,d){
      clickedMap = !clickedMap;
      console.log("Map clicked: "+clickedMap);
      mapMouseOn(e,d);
    });
    function mapMouseOn(e,d){
      //find color of the currentRegion
      var gr = data.regionGroup.top(Infinity);
      var i;
    //  var c;
      for (i = 0; i < gr.length; i++) {
        if (gr[i].key === d.properties['NAME_1']) {
          //console.log(gr[i].value.avg)
          barColor = color(gr[i].value.avg);
        }
      }
    //  return c;
    }

    function mapMouseOut(e,d){

    }

      //Zoom on map
      var mapZoom = d3.zoom()
        .on('zoom', zoomed);

      var zoomSettings = d3.zoomIdentity
        .translate(-3340, 5460)
        .scale(6450);

      d3.select('#map')
        .call(mapZoom)
        .call(mapZoom.transform, zoomSettings);

      function zoomed(e) {
        proj.translate([e.transform.x, e.transform.y])
          .scale(e.transform.k);
        d3.select('#map').selectAll('path')
          .attr('d', gpath);

      }

      //easy print for crossfilter data
      function logGroup(data) {
        data.forEach(function(x) {
          console.log(JSON.stringify(x));
        });
      }
    }
  </script>
</body>

</html>
